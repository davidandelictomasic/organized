@page "/"
@using Organized.Application.Users.User
@inject CreateUserRequestHandler CreateUserHandler
@inject GetUserByEmailRequestHandler LoginHandler

<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

@if (!string.IsNullOrEmpty(loginMessage))
{
    <div class="@(isLoginSuccess ? "success-message" : "error-message")">
        @loginMessage
    </div>
}

<h2>Register</h2>
<EditForm class="user-form" Model="userModel" OnValidSubmit="HandleSubmit" FormName="userForm">
    <div class="form-group">
        <label for="FirstName">Name:</label>
        <InputText @bind-Value="@userModel.Name" id="FirstName" class="form-input" />
    </div>
    <div class="form-group">
        <label for="Email">Email:</label>
        <InputText @bind-Value="userModel.Email" id="Email" class="form-input" />
    </div>
    <div class="form-group">
        <label for="Password">Password:</label>
        <InputText @bind-Value="userModel.Password" id="Password" class="form-input" type="password" />
    </div>
    <button type="submit" class="btn-submit">Register</button>
</EditForm>

<h2>Login</h2>
<EditForm class="user-form" Model="loginModel" OnValidSubmit="HandleLogin" FormName="loginForm">
    <div class="form-group">
        <label for="LoginEmail">Email:</label>
        <InputText @bind-Value="loginModel.Email" id="LoginEmail" class="form-input" />
    </div>
    <div class="form-group">
        <label for="LoginPassword">Password:</label>
        <InputText @bind-Value="loginModel.Password" id="LoginPassword" class="form-input" type="password" />
    </div>
    <button type="submit" class="btn-submit">Login</button>
</EditForm>

@code {

    public class UserModel
    {
        public string? Name { get; set; }
        public string? Email { get; set; }
        public string? Password { get; set; }
    }

    public class LoginModel
    {
        public string? Email { get; set; }
        public string? Password { get; set; }
    }

    [SupplyParameterFromForm(FormName = "userForm")]
    public UserModel? userModel { get; set; } = new();

    [SupplyParameterFromForm(FormName = "loginForm")]
    public LoginModel? loginModel { get; set; } = new();

    private string? loginMessage;
    private bool isLoginSuccess;

    private async Task HandleSubmit(EditContext context)
    {
        var request = new CreateUserRequest
        {
            Name = userModel.Name,
            Email = userModel.Email,
            Password = userModel.Password
        };
        var result = await CreateUserHandler.ProcessActiveRequestAsnync(request);
    }

    private async Task HandleLogin(EditContext context)
        {
            var request = new GetUserByEmailRequest
            {
                Email = loginModel.Email ?? string.Empty,
                Password = loginModel.Password ?? string.Empty
            };
            var result = await LoginHandler.ProcessActiveRequestAsnync(request);

            if (result.Value?.Found == true && result.Value.PasswordMatch)
            {
                loginMessage = $"Hello {result.Value.Email}!";
                isLoginSuccess = true;
            }
            else if (result.Value?.Found == true && !result.Value.PasswordMatch)
            {
                loginMessage = "Invalid password.";
                isLoginSuccess = false;
            }
            else
            {
                loginMessage = "User not found.";
                isLoginSuccess = false;
            }
        }
    }

